jQuery(function($){"use strict";var listing={isMobile:$("html").hasClass("touch"),labels:$("#listing").data("txt"),photoSelector:"#listing .offer .photo",photoInnerSelector:"#listing .offer .photo .inner",init:function(){listing.preview.init();listing.live.init();listing.sorting.init();listing.sidebar.init();listing.message.init();listing.tip.init();listing.views.init();listing.bestmatchstats.init();listing.brandzoneFeatures.init();$("#listing").on("mousedown",".offer",listing.bestmatchstats.clickItem).on("click",".offer",listing.offer.click);$("#offer-preview").on("mousedown",".item-cart",listing.bestmatchstats.clickItem);$("#main-search").on("submit",listing.search.extend);if("1"===$.cookie("cartVersion")){$("#offer-preview").on("click",".item-cart",listing.sendItemToCart)}else{$("#offer-preview").on("click",".item-cart",listing.setAddToCartHref)}$(".dropdown-toggle").on("click",listing.toggleDropdown)},isCartHeaderLoaded:function(){return typeof window.CartClient!=="undefined"},sendItemToCart:function(event){event.preventDefault();if(!listing.isCartHeaderLoaded()){return}var cartId=$.cookie("cartUserId"),itemId=$(this).data("id").toString(),price=parseInt($(this).parent().parent().find(".buy-now").text().match(/[0-9]/g).join(""),10),quantity=1,availableQuantity=parseInt($(this).parent().parent().find(".amount strong:first").text(),10),cartClient=new window.CartClient(cartId,"/cart/","/carts/");cartClient.addItemToCart(itemId,quantity,price,availableQuantity)},setAddToCartHref:function(){var href=$(this).data("href");$(this).attr("href",href)},pageViewsParamsFunction:function(){var bmatchType=new RegExp("[\\?&]bmatch=([^&#]*)").exec(window.location.href),categoryPathIds=$("#breadcrumbs-list").data("cat-path-ids"),searchHits=$("#main-breadcrumb-search-hits").html(),cntMatch=searchHits?searchHits.match(/^\((\d+).+/):false,searchString=$("#main-search-text").val(),parameters={cat:categoryPathIds?categoryPathIds.toString().split(","):[],st:$("div.listing-sort-dropdown div.options dd.selected").data("order"),page:$("#pager-value").val(),lsv:"old",lcv:$.cookie("newListing")?parseInt($.cookie("newListing"),10):0};if(searchString){parameters.search=searchString;parameters.bmv=bmatchType?bmatchType[1]:0;parameters.cnt=cntMatch?cntMatch[1]:""}return parameters},cmEventCatStringFunction:function(){return $("#main-search-text").val()?"Search":"Listing"},sendAnalytics:function(cmFunction){if(window.cm){try{cmFunction()}catch(e){}}},offer:{click:function(e){var parent=$(e.target).closest("article"),url=parent.find("h2 > a"),href=url[0]?url[0].href:undefined;if(e.which===1&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey){e.preventDefault();listing.offer.sendShowItemClickEventData(this,href);listing.offer.fallbackRedirect(href,300)}else{listing.offer.sendShowItemClickEventData(this)}if(e.which===1&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey){$.proxy(listing.live.events.pushWindowScroll,this)()}},sendShowItemClickEventData:function(offer,href){var paramsFunction=function(){var params=listing.pageViewsParamsFunction();params.it={pos:$(offer).index(),id:$(offer).data("id"),promo:$(offer).parent("section").attr("id")==="featured-offers"};return params},callbacks={};if(href){callbacks={onSuccess:function(){document.location.assign(href)},onFailure:function(){document.location.assign(href)}}}listing.sendAnalytics(function(){window.cm.event({cat:listing.cmEventCatStringFunction(),a:"ShowItem"},paramsFunction,callbacks)})},fallbackRedirect:function(url,timeout){setTimeout(function(){document.location.assign(url)},timeout)}},preview:{element:$('<article id="offer-preview" class="offer-preview"></article>').appendTo("body"),additionalData:null,showTimeout:null,closeTimeout:null,mouseover:false,settings:{showDelay:300,closeDelay:200},init:function(){if(listing.isMobile){return}listing.preview.events()},events:function(){$("#listing").on("mouseenter",".offer .photo:not([data-hidetooltip=1])",listing.preview.cancel).on("mouseenter",".offer .photo:not([data-hidetooltip=1])",listing.preview.show).on("mousemove",".offer .photo:not([data-hidetooltip=1])",listing.preview.cancel).on("mousemove",".offer .photo:not([data-hidetooltip=1])",listing.preview.show).on("mouseleave",".offer .photo:not([data-hidetooltip=1])",listing.preview.cancel).on("mouseleave",".offer .photo:not([data-hidetooltip=1])",listing.preview.close);$("#offer-preview").on("click","header a, .gallery .photo a",listing.live.events.pushWindowScroll);$(window).bind("unload",listing.preview.close);listing.preview.element.on("mouseenter",function(){listing.preview.mouseover=true;clearTimeout(listing.preview.closeTimeout)}).on("mouseleave",function(){listing.preview.mouseover=false;listing.preview.closeTimeout=setTimeout(function(){listing.preview.element.hide()},listing.preview.settings.closeDelay)})},show:function(){var showDelay=listing.preview.settings.showDelay,timeSend,timeComplete,offer=$(this).parents(".offer").eq(0),scrollTop=$(window).scrollTop();if(listing.live.requestLocked){return}if(!listing.preview.additionalData){timeSend=(new Date).getTime();listing.preview.getAdditionalData();timeComplete=(new Date).getTime();showDelay=timeComplete-timeSend>showDelay?0:showDelay-(timeComplete-timeSend)}listing.preview.showTimeout=setTimeout(function(){var cancel=$(window).scrollTop()<scrollTop-offer.find(".photo").height()||$(window).scrollTop()>scrollTop+offer.find(".photo").height();if(cancel){return}listing.preview.element.toggleClass("offer-preview-gallery",$("#listing").is(".listing-gallery"));listing.preview.element.show();listing.preview.setPosition(offer);listing.preview.setContent(offer);listing.preview.styleScrolls()},showDelay)},close:function(){listing.preview.closeTimeout=setTimeout(function(){if(!listing.preview.mouseover){listing.preview.element.hide()}},listing.preview.settings.closeDelay)},cancel:function(){clearTimeout(listing.preview.closeTimeout);clearTimeout(listing.preview.showTimeout)},setPosition:function(offer){var width=listing.preview.element.outerWidth(true),offsetTop=$("#listing").is(".listing-simple")?130:100,offsetLeft=$("#listing").is(".listing-gallery")?($(".listing-gallery .offer").outerWidth()-width)/2:offer.find(".photo").outerWidth()/2+40,posTop=offer.offset().top-offsetTop,posLeft=offer.offset().left+offsetLeft,edgeRightExtend=width-($(window).width()-posLeft),edgeTopExtend=posTop-($("#search-bar").outerHeight()+$(window).scrollTop()+10),edgeBottomExtend=0;if(edgeRightExtend>0){posLeft=posLeft-edgeRightExtend}if(edgeTopExtend<0){posTop=$("#search-bar").outerHeight()+$(window).scrollTop()+10}listing.preview.element.css({left:posLeft,top:posTop});edgeBottomExtend=$(window).height()+$(window).scrollTop()-(posTop+listing.preview.element.outerHeight());if(edgeBottomExtend<0){posTop=$(window).height()+$(window).scrollTop()-listing.preview.element.outerHeight()-10;listing.preview.element.css({left:posLeft,top:posTop})}},setContent:function(offer){var currentPhoto=0,gallery=$('<div class="gallery"><div class="photo"><a href="'+offer.find("h2 a").attr("href")+'"></a></div><span class="prev"><span></span></span><span class="next"><span></span></span><ul class="nav"></ul></div>'),content=$('<div class="excerpt"></div>').html(offer.find(".excerpt").html()).find(".photo").remove().end(),params=content.find(".params").clone(),photosExternal=offer.find(".photo").data("external");content.find(".params").remove();$.each(offer.find(".photo").data("img"),function(){var src=this[this.length-1];gallery.find("ul").append('<li><a href="'+src+'"><span></span></a></li>')});if($("#listing").is(".listing-gallery")){content.find(".details").after(content.find(".purchase"))}if(offer.hasClass("promo-bold")){listing.preview.element.addClass("offer-preview-promo-bold")}else{listing.preview.element.removeClass("offer-preview-promo-bold")}listing.preview.element.html(content.html()).data("id",offer.data("id"));listing.preview.element.find(".details").after(gallery);gallery.after(params);gallery.find(".nav a").click(function(){currentPhoto=$(this).parent("li").index();$(this).parent("li").addClass("current").siblings().removeClass("current");gallery.find(".photo").css("background-image","url("+$(this).attr("href")+")");if(photosExternal[currentPhoto]){gallery.find(".photo").append('<span class="desc">'+listing.labels.samplePhoto+"</span>")}else{gallery.find(".photo .desc").remove()}return false});gallery.find(".nav a").eq(0).click();if(gallery.find(".nav a").length<=1){gallery.find(".prev, .next, .nav").hide()}gallery.find(".prev, .next").click(function(e){e.stopPropagation();currentPhoto=$(this).is(".prev")?currentPhoto-1:currentPhoto+1;currentPhoto=currentPhoto%gallery.find(".nav a").length;gallery.find(".nav a").eq(currentPhoto).click()}).hover(function(){listing.preview.element.find("header h2 a").removeClass("hovered")});gallery.find(".photo").hover(function(){listing.preview.element.find("header h2 a").addClass("hovered")},function(){listing.preview.element.find("header h2 a").removeClass("hovered")});listing.preview.element.find(".item-watch").click(listing.preview.addToWatch);listing.tip.init(listing.preview.element)},addToWatch:function(e){if(this.href.match("/myaccount/watch.php")){return}e.preventDefault();$.ajax({url:"/Watchlist.php",type:"post",data:{itemId:$(this).parents(".offer-preview").data("id"),backUrl:window.location.href,token:$("#listing").data("popup").token},dataType:"json",success:function(res){if(res){switch(res.status){case 0:listing.preview.addedToWatch({status:1,link:"/myaccount/watch.php"});break;case 1:listing.preview.addedToWatch({status:0,error:res.message});break;case 2:window.location.assign(res.message);break}}}})},addedToWatch:function(data){var link=listing.preview.element.find(".item-watch");if(data.status&&data.link){link.attr("href",data.link).children().html(link.data("lang"))}else if(data.error){listing.preview.element.prepend($('<p class="error">'+data.error+"</p>"));setTimeout(function(){listing.preview.element.find(".error").fadeOut(100).remove()},5e3)}},getAdditionalData:function(){var data={},offer;data.itemData={};data.pagerLimit=$("#listing .listing-options-bottom .items-per-page .current").text();data.token=$("#listing").data("popup").token;$("#listing .offer").each(function(){offer=$(this);data.itemData[offer.data("id")]=offer.find(".photo").data("popup")});if(data.itemData&&data.pagerLimit&&data.token){$.ajax({url:"/Listing/AdditionalData.php/getAjax",data:{items:data.itemData,pagerLimit:data.pagerLimit,token:data.token},type:"post",async:false,dataType:"json",success:function(response){if(response.data){data.popupData=response.data;listing.preview.dataReceived(data)}}})}},dataReceived:function(data){var attributes,id,offer,userElement;listing.preview.additionalData=data;for(id in data.popupData){offer=$('#listing .offer[data-id="'+id+'"]');userElement=offer.find(".products .user");userElement.prepend(data.popupData[id].s.listingLink);if(data.popupData[id].cartEnabled){offer.find(".item-cart").removeClass("disabled")}attributes=listing.preview.renderAttributes(data.popupData[id].attributes);if(attributes){offer.find(".params.params-all").html("<dl>"+attributes.toLowerCase()+"</dl>")}else{offer.find(".params.params-all").remove()}}},renderAttributes:function(attributes){var attribute,attributeText,key,formattedAttributes=[];for(key in attributes){attribute=attributes[key];attributeText="";if(attribute.value!==""){if(typeof attribute.value==="string"){attributeText+="<dd><span>"+attribute.value+"</span></dd> "}else{attributeText+="<dd><span>"+attribute.value.join("</span></dd> <dd><span>")+"</span></dd> "}if(attribute.unit!==""){attributeText+='<dd class="unit"><span>'+attribute.unit+"</span></dd> "}if(attribute.type==="enum"||key==="region"){attributeText=' <dt class="enum"><span>'+attribute.name+"</span></dt>"+attributeText}else{attributeText=" <dt><span>"+attribute.name+"</span></dt>"+attributeText}}formattedAttributes.push(attributeText)}return formattedAttributes.join("")},styleScrolls:function(){var params=listing.preview.element.find(".params-all dl"),height=parseInt(params.height(),10),showScroll=params.length&&params[0].scrollHeight>height,scrollbarArea;if(showScroll){params.css("max-height","none");params.wrap('<div class="overview" />');params.parents(".overview").wrap('<div class="viewport" />');params.parents(".viewport").wrap('<div class="scrollbar-area" />');scrollbarArea=params.parents(".scrollbar-area");scrollbarArea.prepend('<div class="scrollbar"><div class="track"><div class="thumb"></div></div></div>');scrollbarArea.find(".viewport").css({height:height});scrollbarArea.tinyscrollbar({invertscroll:listing.isMobile})}}},live:{initialUrl:location.href,popped:false,requestLocked:false,requestStash:{},requestObject:null,init:function(){listing.live.transform();listing.live.events.init()},restoreInitState:function(){listing.live.initialUrl=location.href},events:{settings:{pushStateEnabled:window.history.pushState!==undefined&&$("#listing").data("is-live-search-active"),selectInput:false,pagerValue:$("#pager-value").val(),requestTimeout:null},init:function(){if($("#pager-value").length){$("#listing").on("keyup","#pager-value",listing.live.events.pagerInputKeyUp).on("keypress","#pager-value",listing.live.events.pagerInputKeyPress).on("mousedown","#pager-value",listing.live.events.pagerInputMouseDown).on("click","#pager-value",listing.live.events.pagerInputClick);listing.live.resizePager();$("#pager-value").keyup()}$("#display-form").on("keypress","input[type=text]",listing.live.events.paramTextKeyPress).on("keyup","input[type=text]",listing.live.events.paramTextKeyUp).on("focus","input[type=text]",listing.live.events.paramTextFocus).on("blur","input[type=text]",listing.live.events.paramTextBlur).on("change","select",listing.live.events.paramSelectChange).on("click","a.param-toggle",listing.live.events.paramToggleClick);if(listing.live.events.settings.pushStateEnabled){$("#listing").on("click",".pager a, .listing-sort-dropdown .options a",listing.live.events.pagerNavClick);$("#listing").on("click",".items-per-page a",listing.live.events.changePageLimit);$("#display-form").on("change","input[type=checkbox], input[type=radio]",listing.live.events.paramSwitchChange);$("#sidebar-params .widget-header .action-reset").click(listing.live.events.resetForm);$(window).on("popstate",listing.live.events.popState)}else{$("#sidebar-params").on("click",".widget-header .action-reset",listing.live.events.pushWindowScroll);listing.live.autoScroll()}$(window).bind("unload",listing.live.restoreInitState)},dependenciesCheck:{multiRegion:{regionAllCountry:function(el){var urlParams=listing.urlParams(),regionEl=$("ul.multi-region"),allCountryEl=$("li.multi-region-all-country"),paramUpdates={},paramName,exp=new RegExp("multiRegion(.*)"),results;if(allCountryEl.length>0&&allCountryEl.find(el).length>0){for(paramName in urlParams){results=exp.exec(paramName);if(results!==null&&results[1]!=="[allCountry]"){paramUpdates[paramName]=""}}}else if(regionEl.find(el).length>0){for(paramName in urlParams){if(paramName.match(/multiRegion\[allCountry\]/)){paramUpdates[paramName]=""}}}if(exp.exec(el.attr("href"))!==null){if(urlParams.postcode_enabled===undefined||urlParams.postcode_enabled!==undefined&&urlParams.postcode_enabled!=="0"){paramUpdates.postcode_enabled="0"}if(urlParams.city!==undefined){paramUpdates.city=""}}else if(regionEl.find(el).length>0||allCountryEl.find(el).length>0){paramUpdates.postcode_enabled=""}return paramUpdates},regionCity:function(el){var urlParams=listing.urlParams(),multiRegionCityEl=$("ul.multi-region-city"),paramUpdates={},paramName;if(multiRegionCityEl.length>0&&multiRegionCityEl.find(el).length>0){for(paramName in urlParams){if(paramName.match(/multiRegion/)){paramUpdates[paramName]=""}}}return paramUpdates}}},pagerInputKeyUp:function(){listing.live.changePagerNavAction();listing.live.resizePager(200)},pagerInputKeyPress:function(e){var key=e.which?e.which:e.keyCode,pageNo,url;if(key===13){pageNo=parseInt(encodeURI($(this).val().replace(/[^\d]*/g,"")),10);url=listing.live.changeParams({params:{p:pageNo},href:window.location.href});if(listing.live.events.settings.pushStateEnabled){listing.live.request({url:url})}else{window.location.href=url}return false}else if(key>=48&&key<=57||$.inArray(key,[37,38,39,40,46,8])!==-1){return true}else{return false}},pagerInputMouseDown:function(){listing.live.events.settings.selectInput=!$(this).is(":focus")},pagerInputClick:function(){if(listing.live.events.settings.selectInput){$(this).select()}},pagerNavClick:function(){listing.live.request({counters:false,url:$(this).attr("href"),scroll:$(this).parents(".pager-bottom").length?0:false});return false},changePageLimit:function(){var params=listing.urlParams(),requestParams=listing.urlParams($(this).attr("href")),limit=params.limit?params.limit:60,page=params.p?params.p:1,requestLimit=requestParams.limit?requestParams.limit:60,lastPage=Math.ceil(((page-1)*limit+$(".listing .offer").length)/requestLimit),resultPage=Math.min(Math.ceil(page*limit/requestLimit),lastPage),offer=$("#listing .offer:last"),offerId=offer.attr("id"),offerOffsetWindow=offer.offset().top-$(window).scrollTop();resultPage=resultPage>1?resultPage:"";listing.live.request({url:listing.live.changeParams({params:{p:resultPage},href:$(this).attr("href"),lastPage:resultPage}),callback:function(){var offer=$("#listing").find("#"+offerId);if(offer.length){$(window).scrollTop(Math.ceil(offer.offset().top-offerOffsetWindow))}}});return false},paramTextKeyPress:function(e){var key=e.which?e.which:e.keyCode;if(listing.live.events.settings.pushStateEnabled&&key===13){e.preventDefault()}},paramTextKeyUp:function(e){var key=e.which?e.which:e.keyCode,option=$(this),scrollTop=$(window).scrollTop()-$("#sidebar-params").offset().top,paramUpdates={},requestDelay=key===13?0:850,sendRequest,href;paramUpdates=listing.live.events.dependenciesCheck.multiRegion.regionCity(option);if(listing.live.events.settings.pushStateEnabled){clearTimeout(listing.live.events.settings.requestTimeout);listing.live.events.settings.requestTimeout=setTimeout(function(){sendRequest=listing.live.dependentParamsValid(option)&&$.inArray(key,[9,16,35,36,37,38,39,40])===-1;if(sendRequest){href=listing.live.getOptionUrl(option,paramUpdates);listing.live.request({url:href})}},requestDelay)}else{sendRequest=listing.live.dependentParamsValid(option)&&key===13;if(sendRequest){$.proxy(listing.live.events.pushWindowScroll,this)();href=listing.live.getOptionUrl(option,paramUpdates);window.location.href=href}}},paramTextFocus:function(){clearTimeout(listing.live.events.settings.requestTimeout)},paramTextBlur:function(){var option=$(this),paramUpdates={},href,sendRequest=listing.live.dependentParamsValid(option);paramUpdates=listing.live.events.dependenciesCheck.multiRegion.regionCity(option);if(sendRequest){listing.live.events.settings.requestTimeout=setTimeout(function(){if(listing.live.events.settings.pushStateEnabled){href=listing.live.getOptionUrl(option,paramUpdates);listing.live.request({url:href})}else{$.proxy(listing.live.events.pushWindowScroll,option[0])();href=listing.live.getOptionUrl(option,paramUpdates);sendRequest=href.replace(/&scrollTop=[^&]*/,"")!==window.location.href.replace(/&scrollTop=[^&]*/,"");if(sendRequest){window.location.href=href}}},50)}},paramSelectChange:function(){var option=$(this),href,paramUpdates={},parameters=listing.urlParams(),paramSwitch=option.parents("li").eq(0).find("input[type=checkbox], input[type=radio]").eq(0),sendRequest=listing.live.dependentParamsValid(option)&&(typeof parameters[$(this).attr("name")]==="undefined"||parameters[$(this).attr("name")]!==$(this).val()||!paramSwitch.is(":checked"));if(sendRequest){clearTimeout(listing.live.events.settings.requestTimeout);if(listing.live.events.settings.pushStateEnabled){href=listing.live.getOptionUrl(option);listing.live.request({url:href})}else{$.proxy(listing.live.events.pushWindowScroll,this)();href=listing.live.getOptionUrl(option,paramUpdates);window.location.href=href}}},paramToggleClick:function(e){var paramUpdates={},url=$(this).attr("href"),option,requestDelay,el=$(this);if(listing.live.events.settings.pushStateEnabled){option=$(this).parents("li").eq(0).find("input[type=checkbox], input[type=radio]").eq(0);requestDelay=listing.live.requestLocked?0:100;paramUpdates=listing.live.events.dependenciesCheck.multiRegion.regionAllCountry($(this));listing.live.requestStash=$.extend(listing.live.requestStash,listing.live.getOptionParams(option));url=listing.live.getOptionUrl(option,paramUpdates);option.click();clearTimeout(listing.live.events.settings.requestTimeout);listing.live.events.settings.requestTimeout=setTimeout(function(){listing.live.request({url:url})},requestDelay);return false}else{e.preventDefault();$.proxy(listing.live.events.pushWindowScroll,this)();listing.live.autoScroll();paramUpdates=listing.live.events.dependenciesCheck.multiRegion.regionAllCountry(el);if(!$.isEmptyObject(paramUpdates)){url=listing.live.getOptionUrl(el,paramUpdates)}window.location.href=url}},paramSwitchChange:function(){$('input[name="'+$(this).attr("name")+'"]').each(function(){if($(this).is(":checked")){$(this).parent().find("a").addClass("checked")}else{$(this).parent().find("a").removeClass("checked")}})},popState:function(){var initialPop=location.href===listing.live.initialUrl;if(!initialPop){listing.live.request({url:location.href,pop:true});if("state.title"in window.history){document.title=window.history.state.title}}},resetForm:function(){listing.live.request({url:$(this).attr("href")});return false},pushWindowScroll:function(){var scrollToParam=!listing.live.events.settings.pushStateEnabled&&window.sessionStorage&&$(this).parents("ul").length>0,scrollToOffer=$(this).is(".offer")||$(this).parents("#offer-preview").length>0;if(scrollToOffer){window.localStorage.setItem("scrollToOffer",JSON.stringify({offset:$(window).scrollTop()-$("#listing").offset().top,location:window.location.href}))}else if(scrollToParam){window.sessionStorage.setItem("toggleList",JSON.stringify({windowListOffset:parseInt($(this).parents("ul").offset().top-$(window).scrollTop(),10),toggleListIndex:parseInt($(this).parents("ul").index(".sidebar .widget-params fieldset ul"),10),toggleListExpand:$(this).parents(".scrollbar-area").hasClass("params-limit-more")?1:0,toggleListOffset:Math.abs(parseInt($(this).parents(".overview").css("top"),10))}))}},popWindowScroll:function(){var storage=window.sessionStorage&&window.sessionStorage.getItem("toggleList")&&JSON.parse(window.sessionStorage.getItem("toggleList")),scrollToParam=storage&&!listing.live.events.settings.pushStateEnabled&&typeof storage.toggleListIndex!=="undefined",scrollToOffer=window.localStorage&&window.localStorage.getItem("scrollToOffer")&&JSON.parse(window.localStorage.getItem("scrollToOffer"));if(scrollToParam){listing.live.autoScroll({storage:storage})}else if(scrollToOffer){if(scrollToOffer.location===window.location.href){listing.live.autoScroll({scrollToOffer:scrollToOffer.offset})}window.localStorage.removeItem("scrollToOffer")}}},dependentParamsValid:function(el){var validParam=function(param){if(el.val()===""||el.hasClass("placeholder")){if(param.val()!==""&&!param.hasClass("placeholder")||param.hasClass("input-error")){return false}}else if(param.val()===""||param.hasClass("placeholder")||param.hasClass("input-error")){return false}return true},params=el.data("dependent"),valid=true,param,id;if(el.hasClass("input-error")){valid=false}else{for(id in params){param=$('[name="'+params[id]+'"]');if(param.length&&!validParam(param)){valid=false;break}}}return valid},changeParams:function(options){var escapeRegExp=function(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},pageNo=function(){var p=options.params.p,lastPage=options.lastPage?options.lastPage:parseInt($("#pager-top").attr("rel"),10);return p>1?p>lastPage?lastPage:p:""}(),paramName,paramValue,exp,match,result;options.params=$.extend({counters:"",msg:"",requestCategory:"",requestDepartment:""},options.params);$.each($("#listing").data("excludedparameters"),function(key,value){options.params[value]=""});options.params.p=pageNo;options.href=options.href?options.href:window.location.href;result=decodeURI(options.href.replace(/%25/g,"%2525"));for(paramName in options.params){paramValue=options.params[paramName];exp=new RegExp("[?&]"+escapeRegExp(paramName)+"=[^&]*","g");match=result.match(exp);if(paramValue===""&&match){if(match[0][0]==="?"){result=result.replace(exp,"?")}else{result=result.replace(exp,"")}}else if(paramValue!==""){if(match){result=result.replace(exp,match[0][0]+paramName+"="+paramValue)}else if(result.indexOf("?")!==-1){result=result+"&"+paramName+"="+paramValue}else{result=result+"?"+paramName+"="+paramValue}}}result=result.replace("?&","?");if(result[result.length-1]==="?"||result[result.length-1]==="&"){result=result.substr(0,result.length-1)}result=encodeURI(result);result=result.replace(/%25/g,"%");return result},changeCounters:function(paramCounters,categoryCounters,totalCounter){var amount,counter,input,label,paramName,paramValue,isNotEmptyCategory=false,categoryId=0,categoryName=$("#sidebar-categories").data("root-category-name"),totalCounterField=$("#main-breadcrumb-search-hits");if(paramCounters!==undefined){for(paramName in paramCounters.paramCounts){for(paramValue in paramCounters.paramCounts[paramName]){input=$('input[name="'+paramName+'"][value="'+paramValue+'"]');if(input.length!==1){input=$("#"+paramName+"_"+paramValue)}amount=paramCounters.paramCounts[paramName][paramValue];if(input.is("input")){counter=input.parent().find(".count");label=$('label[for="'+input.attr("id")+'"]');counter.text(" ("+amount+")");if(amount>0){label.removeClass("disabled")}else{label.addClass("disabled")}}else if(input.is("option")){input.text(input.text().replace(/\(\d*\)$/,"("+amount+")"))}input.parents("li").attr("data-custom-order",amount).data("customOrder",amount)}}for(paramName in paramCounters.attribCounts){input=$('input[name="'+paramName+'"]');counter=input.parent().find(".count");amount=paramCounters.attribCounts[paramName];label=$('label[for="'+input.attr("id")+'"]');counter.text(" ("+amount+")");if(amount>0){label.removeClass("disabled")}else{label.addClass("disabled")}input.parents("li").attr("data-custom-order",amount).data("customOrder",amount)}}if(categoryCounters!==undefined){$(".sidebar-cat").addClass("empty");$(".sidebar-cat .count").text(" (0)");for(paramName in categoryCounters){input=$("#sidebar-cat-"+paramName);counter=input.find(".count");amount=categoryCounters[paramName];counter.text(" ("+amount+")");if(amount!==0){input.removeClass("empty");isNotEmptyCategory=true}}$("#sidebar-categories .widget-nav ul .parent-empty").remove();if(isNotEmptyCategory===false){categoryId=$("#sidebar-categories").data("current-category-id");if(categoryId>0){categoryName=$("#sidebar-categories").data("current-category-name")}if($("#sidebar-categories .widget-nav ul .current").length===0){$("#sidebar-categories .widget-nav ul").append('<li id="sidebar-cat-'+categoryId+'" class="sidebar-cat current parent-empty"><span class="name">'+categoryName+'</span><span class="count"> (0)</span></li>')}}}if(totalCounter!==undefined&&totalCounter.length!==0&&totalCounterField.length>0){totalCounterField.text(" ("+totalCounter+")")}},autoScroll:function(options){var settings=$.extend({scrollToOffer:null,scrollToParam:null,storage:null,parameters:listing.urlParams()},options);if(settings.scrollToParam){$(window).scrollTop(Math.ceil(settings.scrollToParam)+$("#sidebar-params").offset().top)}else if(settings.scrollToOffer){$(window).scrollTop(Math.ceil(settings.scrollToOffer)+$("#listing").offset().top)}else if(settings.storage){$(window).scrollTop($(".sidebar .widget-params ul").eq(settings.storage.toggleListIndex).offset().top-settings.storage.windowListOffset);window.sessionStorage.removeItem("toggleList")}else if(settings.parameters.scrollTop){$(window).scrollTop(parseInt(settings.parameters.scrollTop,10)+$("#sidebar-params").offset().top)}},getClearUrl:function(){var baseUrl,masks=["a_mask","a_text","a_enum","a_date"],paramName="",paramUpdates={},parameters=listing.urlParams(),removeParam;for(paramName in parameters){removeParam=$('#display-form [name="'+paramName+'"]').length===0?$.inArray(paramName.substr(0,6),masks)!==-1:!$('#display-form [name="'+paramName+'"]').is("[type=hidden]");if(removeParam){paramUpdates[paramName]=""}}baseUrl=listing.live.changeParams({params:paramUpdates});return baseUrl},getOptionParams:function(option,paramUpdates){var optionSet=option.parents("li").eq(0).find("input, select").not("[type=checkbox], [type=radio]"),paramSwitch=option.parents("li").eq(0).find("input[type=checkbox], input[type=radio]").eq(0),emptySet=optionSet.length!==0?true:paramSwitch.is(":checked"),removeParam;paramUpdates=paramUpdates?paramUpdates:{};optionSet.each(function(){removeParam=$(this).val()===""||$(this).hasClass("placeholder")||$(this).hasClass("input-error")||option.is(paramSwitch)&&paramSwitch.is(":checked");paramUpdates[$(this).attr("name")]=removeParam?"":$(this).val();if(!removeParam){emptySet=false}});paramUpdates[paramSwitch.attr("name")]=emptySet?"":paramSwitch.val();if(paramSwitch.is("[type=radio]")){$('input[name="'+paramSwitch.attr("name")+'"]').not(paramSwitch).each(function(){option=$(this);optionSet=option.parents("li").eq(0).find("input, select").not("[type=checkbox], [type=radio]");optionSet.each(function(){paramUpdates[$(this).attr("name")]=""})})}return paramUpdates},getOptionUrl:function(option,paramUpdates){var href="",params;paramUpdates=paramUpdates?$.extend(listing.live.requestStash,paramUpdates):listing.live.requestStash;params=listing.live.getOptionParams(option,paramUpdates);href=listing.live.changeParams({params:params});return href},changePagerNavAction:function(){var pager=$("#pager-top"),pagerValue=$("#pager-value").val(),prev=parseInt(listing.live.events.settings.pagerValue,10)-1,next=parseInt(listing.live.events.settings.pagerValue,10)+1,arrowNext=pager.find("li.next a"),arrowPrev=pager.find("li.prev a");if(pagerValue!==listing.live.events.settings.pagerValue&&pagerValue!==""){prev=next=pagerValue}arrowPrev.attr("href",listing.live.changeParams({params:{p:prev}}));arrowNext.attr("href",listing.live.changeParams({params:{p:next}}))},resizePager:function(speed){if($("#pager-value").length===0){return}var pagerInput=$("#pager-value"),inputLength=pagerInput.val().length>1?pagerInput.val().length-1:1,maxLength=pagerInput.parents(".pager").attr("rel").length,charRemains=maxLength-pagerInput.val().length;speed=speed?speed:0;if(charRemains>=0){pagerInput.attr("size",inputLength).stop().animate({width:inputLength*8+20+"px"},speed).css("overflow","visible")}else{pagerInput.val(pagerInput.val().substring(0,maxLength))}},transform:function(options){var form=$("#display-form"),categories=$("#sidebar-categories .widget-nav li"),levelUpLink=$("#sidebar-categories .widget-header a.level-up"),addToFavCatButton=$("#add-category-to-favourites"),addToFavSearchButton=$("#add-search-to-favourites"),parameters=listing.urlParams(),hrefParts,offerType,hrefParams,href;options=$.extend({href:window.location.href},options);parameters=listing.urlParams(options.href);form.find("li").each(function(){var param=$(this),label=param.find("label").eq(0),optionSet=param.find("input, select"),paramSwitch=optionSet.filter("[type=checkbox], [type=radio]"),hasParamToggle=param.find(".param-toggle").length,paramToggle,paramUpdates={},removeParam,restoreParam=false,href="";if(paramSwitch.length){if(hasParamToggle===0){paramToggle=$('<a class="param-toggle" href=""></a>')}else{paramToggle=param.find(".param-toggle")}restoreParam=typeof parameters[paramSwitch.attr("name")]!=="undefined"?paramSwitch.val()===parameters[paramSwitch.attr("name")]:paramSwitch.hasClass("default-value");if(restoreParam){paramSwitch.prop("checked",true);paramToggle.addClass("checked");optionSet.filter("input[type=text], select").each(function(){if(!$(this).is(":focus")||options.pop){$(this).val(decodeURI(typeof parameters[$(this).attr("name")]==="undefined"?"":parameters[$(this).attr("name")]))
}})}else{paramSwitch.prop("checked",false);paramToggle.removeClass("checked");optionSet.filter("input[type=text], select").each(function(){var defaultValue=typeof $(this).data("defaultValue")!=="undefined"?$(this).data("defaultValue"):$(this).is("select")?$(this).find("option").eq(0).val():"";$(this).val(defaultValue)})}optionSet.filter("select[placeholder]").each(function(){if($(this).attr("placeholder")===$(this).find(":selected").text()){$(this).addClass("placeholder")}else{$(this).removeClass("placeholder")}});removeParam=paramSwitch.is(":checked")||typeof parameters[paramSwitch.attr("name")]!=="undefined"&&parameters[paramSwitch.attr("name")]===paramSwitch.val();optionSet.each(function(){paramUpdates[$(this).attr("name")]=removeParam?"":$(this).val()});href=listing.live.changeParams({params:paramUpdates,href:options.href});paramToggle.attr("href",href);if(hasParamToggle===0){if(label.length){paramToggle.html("<span>"+label.html()+"</span>");label.html(paramToggle)}else{paramToggle.insertAfter(paramSwitch)}}}});categories.each(function(){var category=$(this),link=category.find("a"),linkParams=listing.urlParams(link.attr("href")),id=category.attr("id"),href,paramUpdates;if(id!==undefined&&id.match("sidebar-cat-")&&link.length){paramUpdates=$.extend(listing.urlParams(options.href),{category:"",p:"",id:typeof linkParams.id!=="undefined"?linkParams.id:""});href=listing.live.changeParams({params:paramUpdates,href:link.attr("href").match(/[^?]*/)[0]});link.attr("href",href)}});if(levelUpLink.data("parent")>0){hrefParams=listing.urlParams(levelUpLink.attr("href"));href=listing.live.changeParams({params:$.extend(listing.urlParams(options.href),{id:typeof hrefParams.id!=="undefined"?hrefParams.id:"",search_scope:"",category:""}),href:levelUpLink.attr("href").match(/[^?]*/)[0]});levelUpLink.attr("href",href)}if(addToFavCatButton.length>0){offerType=$("#display-form #buyNowParam:checked").length;addToFavCatButton.prop("onclick",null).click(function(e){e.preventDefault();window.location.href="/myaccount/favourites/favourites_categories.php/addNew/?catId="+$("#sidebar-categories").data("current-category-id")+"&buy="+offerType})}if(addToFavSearchButton.length>0){href=window.location.href;hrefParts=href.split("?");hrefParams=hrefParts[1];addToFavSearchButton.prop("onclick",null).click(function(e){e.preventDefault();if(hrefParams.substr(0,3)==="id="){hrefParams="category="+hrefParams.substr(3)}else{hrefParams=hrefParams.replace(/\&id\=/gi,"&category=");hrefParams=hrefParams.replace(/\&search_scope=category-/gi,"&category=")}window.location.href="/myaccount/favourites/favourites_search.php/addNew/?"+hrefParams})}$("#sidebar-params .widget-header .action-reset").attr("href",listing.live.getClearUrl())},request:function(options){var loaderPosLeft,loaderPosTop,loaderOffsetTop,delay=100,scrollToParam,timeSend,timeComplete,skipRequest;options=$.extend({counters:true,url:"",pop:false,scroll:false,callback:function(){}},options);skipRequest=options.url===window.location.href;if(skipRequest&&!options.pop){return}if(listing.live.requestObject){listing.live.requestObject.abort()}listing.live.requestObject=$.ajax({url:options.url.replace(/listing.php/i,"items.php"),data:options.counters?{counters:1,t:1}:{t:1},beforeSend:function(){$("#listing").trigger("beforeSend");timeSend=(new Date).getTime();if(options.scroll!==false){$(window).scrollTop(options.scroll)}else{scrollToParam=$(window).scrollTop()-$("#sidebar-params").offset().top}if(!listing.live.requestLocked){$("#listing").append('<div id="listing-loader" class="listing-loader">'+listing.labels.loading+"</div>");$("#listing, .recommended-listing .recommended").addClass("listing-loading")}listing.live.requestLocked=true;loaderPosLeft=$("#listing").offset().left+$("#listing").width()/2-$("#listing-loader").outerWidth()/2;loaderOffsetTop=($(window).height()-$("#main-header.sticky #search-bar").outerHeight()-$("#listing-loader").outerHeight())/2;loaderPosTop=$(window).scrollTop()>$("#listing").offset().top?loaderOffsetTop:$("#listing").offset().top/2+loaderOffsetTop;$("#listing-loader").css({left:loaderPosLeft+"px",top:loaderPosTop+"px"})},success:function(data){timeComplete=(new Date).getTime();delay=timeComplete-timeSend>delay?0:delay-(timeComplete-timeSend);setTimeout(function(){var paramCounters=$(data).data("counters"),categoryCounters=$(data).data("catcounters"),totalCounter=$(data).data("totalcounter"),viewOption=listing.views.getViewName(),currentTitle=$(data).data("headtitle");$("#listing").html($(data).html());if(paramCounters||categoryCounters||totalCounter){listing.live.changeCounters(paramCounters,categoryCounters,totalCounter)}listing.live.requestStash={};listing.preview.additionalData=null;listing.live.resizePager();listing.tip.init($("#listing"));if(!options.pop){document.title=currentTitle;window.history.pushState({title:currentTitle},null,options.url)}listing.views.saveChange=false;$(".listing-options .listing-views").find(".view-option[data-view="+viewOption+"]").click();listing.views.saveChange=true;listing.live.transform({pop:options.pop,href:options.url});listing.live.autoScroll({scrollToParam:scrollToParam});listing.live.refreshAnalytics();listing.live.restoreInitState();options.callback();$("#listing").trigger("update");listing.bestmatchstats.increaseStatsCounter()},delay)},complete:function(jq,status){if(status!=="abort"){setTimeout(function(){listing.live.requestLocked=false;$("#listing, .recommended-listing .recommended").removeClass("listing-loading")},delay)}}})},refreshAnalytics:function(){listing.sendAnalytics(function(){window.cm.pv();window.cm.event({cat:listing.cmEventCatStringFunction(),a:"ShowListing"},listing.pageViewsParamsFunction)})}},sorting:{init:function(){listing.sorting.dropdown()},dropdown:function(){$("body").click(function(e){var wrapper=$(".listing-sort-dropdown");if($(e.target).closest(wrapper.find(".label")).length){wrapper.toggleClass("active")}else{wrapper.removeClass("active")}});$(".listing-sort-dropdown .options dl dd a").click(function(e){$.cookie("order",$(this).parent().data("order"),{path:"/",domain:$(".main-search").data("cookie-domain")})})}},urlParams:function(url){var vars={};url=url?url:window.location.href;url.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(m,key,value){vars[decodeURI(key)]=value});return vars},sidebar:{init:function(){var placeholderSupported=document.createElement("input").placeholder!==undefined,resultsCount=parseInt($("#main-breadcrumb-search-hits").text().match(/\d+/),10),parameters=listing.urlParams(),mainSearch=$("#main-search");if($("#sidebar-categories .widget-header").data("helptipBody")){$("#sidebar-categories .widget-header").helptip({event:"display",tStart:0,tStop:7e3,pos:"r",css:"vela-listing-tip"})}mainSearch.data("helptipBody",$("#sidebar-categories .widget-header").data("helptipDescriptionBody"));if($("#sidebar-categories .widget-header").data("helptipDescriptionBody")){mainSearch.helptip({event:"display",tStart:0,tStop:7e3,pos:"r",css:"vela-listing-tip"})}if(resultsCount===0&&parameters.requestDescription){mainSearch.find(".in-description input").prop("checked",false).val(0)}if(!placeholderSupported){listing.sidebar.addPlaceholders()}listing.sidebar.styleSelects();listing.sidebar.scrolls.init();listing.sidebar.seo();listing.live.events.popWindowScroll();$("#sidebar-categories .widget-nav li").on("click",listing.sidebar.categoryClick)},addPlaceholders:function(){$("#sidebar-params input[type=text]").each(function(){var input=$(this);input.focus(function(){if(input.val()===input.attr("placeholder")){input.val("").removeClass("placeholder")}}).blur(function(){if(input.val()===""||input.val()===input.attr("placeholder")){input.val(input.attr("placeholder")).addClass("placeholder")}});if(input.val()===""){input.val(input.attr("placeholder")).addClass("placeholder")}})},categoryClick:function(e){var href=$(this).find("a").attr("href");if(href&&e.which===1&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey){location.href=href}},styleSelects:function(){if(!$.browser.opera&&!$.browser.msie){$("#sidebar-params form select").each(function(){$(this).wrap('<div class="styled-select" />')})}$("#sidebar-params form select[placeholder]").each(function(){var select=$(this);select.change(function(){if(select.attr("placeholder")===select.find(":selected").text()){select.addClass("placeholder")}else{select.removeClass("placeholder")}});if(select.attr("placeholder")===select.find(":selected").text()){select.addClass("placeholder")}})},scrolls:{settings:{itemsCollapsed:5,itemsExpanded:10},init:function(){var storage=window.sessionStorage&&window.sessionStorage.getItem("toggleList")&&JSON.parse(window.sessionStorage.getItem("toggleList"));$(".sidebar .widget-params fieldset ul").not(".params-limit-all").each(function(){var list=$(this),toggleLink=$($("#sidebar-params-toggle-link").html()),listModyfied=storage&&storage.toggleListIndex===$(this).index(".sidebar .widget-params fieldset ul"),listExpanded=listModyfied&&storage.toggleListExpand,listClass=listExpanded?"params-limit-less":"params-limit-more",rows,wrapper,offerCount;if(list.find("li").length<=listing.sidebar.scrolls.settings.itemsCollapsed){return}list.wrap('<div class="overview" />');list.parents(".overview").wrap('<div class="viewport" />');list.parents(".viewport").wrap('<div class="scrollbar-area" />');wrapper=list.parents(".scrollbar-area");wrapper.addClass(listClass);wrapper.prepend('<div class="scrollbar"><div class="track"><div class="thumb"></div></div></div>');rows=list.find("li");rows.each(function(index){offerCount=$(this).find(".count").text().match(/\d+/);$(this).attr("data-default-order",index+1).data("defaultOrder",index+1).attr("data-custom-order",offerCount?offerCount[0]:"").data("customOrder",offerCount?offerCount[0]:"")});wrapper.append(toggleLink);toggleLink.on("click",listing.sidebar.scrolls.toggleList);toggleLink.trigger("click",[storage&&storage.toggleListOffset?storage.toggleListOffset:0])})},toggleList:function(e,scrollTop){var scrollbarArea=$(this).parents(".scrollbar-area"),list=scrollbarArea.find("ul"),expand=!scrollbarArea.hasClass("params-limit-more"),showAll=false,height;scrollbarArea.toggleClass("params-limit-more",expand);scrollbarArea.toggleClass("params-limit-less",!expand);list.html(listing.sidebar.scrolls.getSortedList(list,expand));height=listing.sidebar.scrolls.getListHeight(list,expand);showAll=list[0].scrollHeight<=height+2;scrollbarArea.find(".viewport").css({height:height}).end();scrollbarArea.tinyscrollbar({invertscroll:listing.isMobile,size:height,scroll:expand&&!showAll});scrollbarArea.tinyscrollbar_update(scrollTop);scrollbarArea.toggleClass("params-limit-all",showAll);return false},defaultOrder:function(rows){return rows.sort(function(a,b){return $(a).attr("data-default-order")-$(b).attr("data-default-order")})},customOrder:function(rows){return rows.sort(function(a,b){var result=0;if(!$(a).find(".param-toggle").hasClass("checked")&&$(b).find(".param-toggle").hasClass("checked")){result=1}else if($(a).find(".param-toggle").hasClass("checked")&&!$(b).find(".param-toggle").hasClass("checked")){result=-1}else{result=$(b).attr("data-custom-order")-$(a).attr("data-custom-order")}if(result===0){result=$(a).attr("data-default-order")-$(b).attr("data-default-order")}return result})},getSortedList:function(list,expand){var rows=list.find("li"),sorted=expand?listing.sidebar.scrolls.defaultOrder(rows.clone()):listing.sidebar.scrolls.customOrder(rows.clone());return sorted},getListHeight:function(list,expand){var height=0,breakLoop=false,includeLength=0,visibleItems=expand?10:5;list.find("li").each(function(){breakLoop=!expand&&includeLength>=visibleItems&&$(this).find(".param-toggle.checked").length===0||expand&&includeLength>=visibleItems;if(breakLoop){return false}else{height+=$(this).outerHeight(true);includeLength++}});return height}},seo:function(){var seoWidget=$(".seo-module"),seoTextContainer=$(".seo-module .content"),seoTextContainerCurrentHeight=seoTextContainer.height();seoWidget.find("a").click(function(e){e.stopPropagation()});if(seoWidget.length>0){seoWidget.toggle(function(){var seoTextContainerMaxHeight=seoTextContainer.css("height","auto").height();seoTextContainer.height(seoTextContainerCurrentHeight).animate({height:seoTextContainerMaxHeight});seoWidget.addClass("active")},function(){seoTextContainer.animate({height:seoTextContainerCurrentHeight});seoWidget.removeClass("active")});$("#listing").on("beforeSend",function(){seoWidget.remove()})}}},views:{saveChange:false,init:function(){listing.sendAnalytics(function(){window.cm.event({cat:listing.cmEventCatStringFunction(),a:"ShowListing"},listing.pageViewsParamsFunction)});$("#listing").on("click",".listing-options .listing-views > .view-option",listing.views.change).on("mouseenter",".listing-options .listing-views > .view-option",listing.views.preview.show).on("mouseleave",".listing-options .listing-views > .view-option",listing.views.preview.hide);$('.listing-options .listing-views > .view-option[data-view="'+listing.views.getViewName()+'"]').click();listing.views.saveChange=true;$(window).resize(function(){listing.views.resize()});$(window).resize()},getViewName:function(){var viewOption=$(".listing-options .listing-views").find(".view-option[data-view="+$.cookie("listingViewOption")+"]").length,viewNameDefault="listing-normal",viewName="",parameters=listing.urlParams(),viewOptionBmatch=$(".listing-options .listing-views").find(".view-option[data-view="+parameters.bmatchView+"]").length;if(parameters.view&&parameters.view==="gal"){viewName="listing-gallery"}else if(viewOption){viewName=$.cookie("listingViewOption")}if(viewName===""&&viewOptionBmatch&&parameters.bmatchView){viewName=parameters.bmatchView}if(viewName===""){viewName=viewNameDefault}return viewName},change:function(){if($(this).is(".view-option")){$(this).addClass("current").parents(".listing").eq(0).addClass($(this).data("view"));$(this).siblings().each(function(){$(this).removeClass("current").parents(".listing").eq(0).removeClass($(this).data("view"))});if(listing.views.saveChange){$.cookie("listingViewOption",$(this).data("view"),{path:"/"})}}if($(this).data("view")==="listing-gallery"){listing.views.resizeGallery();listing.preview.settings.showDelay=450}else{listing.views.reset();listing.preview.settings.showDelay=300}listing.views.loadThumbs();return false},preview:{el:$('<div id="listing-preview" class="listing listing-preview"></div>').appendTo("body"),showTimeout:null,closeTimeout:null,settings:{showDelay:400,closeDelay:0},show:function(){var currentTarget=$(this),el=listing.views.preview.el,listingPreview;if($.browser.msie&&$.browser.version<9||$("#listing").hasClass(currentTarget.data("view"))||listing.isMobile){return}listing.views.preview.showTimeout=setTimeout(function(){el.html("");el.attr("class","listing listing-preview").addClass($(currentTarget).data("view"));listingPreview=$("#listing").clone().find(".photo").css("height","").end().find(".photo .inner").css("width","").css("height","").end();listingPreview.find(".photo").each(function(){var images=$(this).data("img");if(images.length){$(this).find(".inner").css({"background-image":"url("+images[0][1]+")"})}else{$(this).find(".inner").css({"background-image":""})}});el.append(listingPreview.find(".offer:lt(9)"));el.css({position:"absolute",top:-($("#listing-preview").height()*.6)/2+currentTarget.offset().top+13+"px",left:-($("#listing-preview").width()*.6)+currentTarget.offset().left+220+"px"}).show()},listing.views.preview.settings.showDelay);clearTimeout(listing.views.preview.closeTimeout)},hide:function(){clearTimeout(listing.views.preview.showTimeout);listing.views.preview.closeTimeout=setTimeout(function(){listing.views.preview.el.html("").hide()},listing.views.preview.settings.closeDelay)}},reset:function(){$(this.photoSelector).css("height","");$(this.photoInnerSelector).css("width","").css("height","")},resize:function(){listing.views.resizeGallery()},resizeGallery:function(){if(!$("#listing").hasClass("listing-gallery")){return}var photoWidth=$("#listing .offer").width()-26,ratio=photoWidth/240,photoHeight=180*ratio;$(this.photoSelector).css("height",photoHeight+"px");$(this.photoInnerSelector).css("width",photoWidth+"px").css("height",photoHeight+"px")},loadThumbs:function(){var imageIndex=1,thumbs=[],offsets=[],skipThumbs=[],scrollTop,windowHeight;if($("#listing").is(".listing-simple")){imageIndex=0}else if($("#listing").is(".listing-gallery")){imageIndex=2}$(listing.photoSelector).each(function(index,photo){photo=$(photo);if(photo.data("img")&&photo.data("img").length){thumbs.push(photo);offsets.push(photo.offset().top)}});function showThumb(el){var images=el.data("img"),preloadedImg=null;if(images.length){el.addClass("loading");preloadedImg=new Image;preloadedImg.onload=function(){el.find(".inner").css({"background-image":"url("+images[0][imageIndex]+")"}).end().removeClass("loading")};preloadedImg.onerror=function(){el.removeClass("loading")};preloadedImg.src=images[0][imageIndex]}}function watchThumbs(){skipThumbs=[];scrollTop=$(window).scrollTop();windowHeight=$(window).height();$.each(offsets,function(index,thumb){if(thumb<scrollTop||$.inArray(index,skipThumbs)!==-1){return true}else if(thumb<scrollTop+windowHeight+thumbs[index].parents(".offer").height()){showThumb(thumbs[index]);skipThumbs.push(index)}else{return false}});skipThumbs.reverse();$.each(skipThumbs,function(i,j){offsets.splice(j,1);thumbs.splice(j,1)})}$(window).unbind("scroll.watchThumbs").unbind("resize.watchThumbs").bind({"scroll.watchThumbs":watchThumbs,"resize.watchThumbs":watchThumbs});watchThumbs()}},search:{extend:function(){function htmlspecialchars(str){if(typeof str==="string"){str=str.replace(/&/g,"&amp;");str=str.replace(/"/g,"&quot;");str=str.replace(/'/g,"&#039;");str=str.replace(/</g,"&lt;");str=str.replace(/>/g,"&gt;")}return str}var buffer="";$("#display-form li input:checked").each(function(){$(this).parent().find("input, select").each(function(){buffer+='<input type="hidden" name="'+$(this).attr("name")+'" value="'+htmlspecialchars($(this).val())+'" />'})});$(this).append(buffer)}},message:{init:function(){var parameters=listing.urlParams();if(typeof parameters.messageType!=="undefined"&&parameters.messageType!==null&&typeof parameters.success!=="undefined"){if(parameters.messageType==="category"){listing.message.determineCategoryPopup(parameters.success)}else if(parameters.messageType==="seller"){listing.message.determineSellerPopup(parameters.success)}}$("#listing .listing-message .sub-message a").on("click",listing.message.action)},action:function(e){e.preventDefault();if($("#listing .listing-message").data("messageType")==="category"){listing.message.checkFavouriteCategories()}else if($("#listing .listing-message").data("messageType")==="seller"){listing.message.checkFavouriteSellers()}},checkFavouriteCategories:function(){$.ajax({type:"POST",data:{id:$('form[name="display-form"] input[name="id"]').val(),token:$('form[name="display-form"]').data("token")},url:"/myaccount/favourites/favouritesCategories.php/checkAndAddAjax",statusCode:{401:function(){var f=$('<form method="post" action="/myaccount/favourites/favouritesCategories.php/redirect"></form>');f.html('<input type="hidden" id="referer" name="referer" value="'+window.location.href+'" />'+'<input type="hidden" id="category" name="category" value="'+$('form[name="display-form"] input[name="id"]').val()+'" />');f.appendTo($("body"));f.submit()}},success:function(returnData){listing.message.determineCategoryPopup(returnData.success)}})},checkFavouriteSellers:function(){$.ajax({type:"POST",data:{id:$('form[name="display-form"] input[name="us_id"]').val(),token:$('form[name="display-form"]').data("token")},url:"/myaccount/favourites/favouritesSellers.php/checkAndAddAjax",statusCode:{401:function(){var f=$('<form method="post" action="/myaccount/favourites/favouritesSellers.php/redirect"></form>');f.html('<input type="hidden" id="referer" name="referer" value="'+window.location.href+'" />'+'<input type="hidden" id="seller" name="seller" value="'+$('form[name="display-form"] input[name="us_id"]').val()+'" />');f.appendTo($("body"));f.submit()}},success:function(returnData){listing.message.determineSellerPopup(returnData.success)}})},determineCategoryPopup:function(status){var messages=$(".listing-message").data("messages");switch(status){case 2:case"2":listing.message.displayPopoverMessage(messages.categoryAlreadyInFavs,messages.categoryAlreadyInFavsSub);break;case 1:case"1":case true:listing.message.displayPopoverMessage(messages.categoryAdded,messages.categoryAddedSub);break;default:listing.message.displayPopoverMessage(messages.genericError,messages.genericErrorSub)}},determineSellerPopup:function(status){var messages=$(".listing-message").data("messages");switch(status){case 2:case"2":listing.message.displayPopoverMessage(messages.userAlreadyInFavs,messages.userAlreadyInFavsSub);break;case 1:case"1":case true:listing.message.displayPopoverMessage(messages.userAdded,messages.userAddedSub);break;default:listing.message.displayPopoverMessage(messages.genericError,messages.genericErrorSub)}},displayPopoverMessage:function(topMessage,bottomMessage){var modal=$("#listing-message-modal");modal.find(".modal-header h3").html(topMessage);modal.find(".modal-body").html(bottomMessage);modal.modal({show:true}).css({"margin-top":-120+"px","margin-left":-(modal.outerWidth()/2)+"px"})}},tip:{init:function(scope){var listingMessages=$.parseJSON($("#listing-icon-info").html());scope=scope?scope:$("body");$(".icon-as",scope).helptip({event:"hover",tStart:0,pos:"r",css:"vela-listing-tip sa-tip",hoverDelay:0,customBody:listingMessages.standardAllegro});$(".icon-fs",scope).helptip({event:"hover",tStart:0,pos:"r",css:"vela-listing-tip sa-tip",hoverDelay:0,customBody:listingMessages.freeShipping});$(".icon-fr",scope).helptip({event:"hover",tStart:0,pos:"r",css:"vela-listing-tip sa-tip",hoverDelay:0,customBody:listingMessages.freeReturn});$(".icon-lp",scope).helptip({event:"hover",tStart:0,pos:"r",css:"vela-listing-tip lp-tip",hoverDelay:0,customBody:listingMessages.loyaltyProgram});$(".icon-pi",scope).helptip({event:"hover",tStart:0,pos:"r",css:"vela-listing-tip pi-tip",hoverDelay:0,customBody:listingMessages.installmentAvailable})}},bestmatchstats:{init:function(){var parameters=listing.urlParams(),stats,lengthDiff,resultsCount=parseInt($("#main-breadcrumb-search-hits").text().match(/\d+/),10),selectedOrder=$("div.listing-sort-dropdown div.options dd.selected").data("order"),categoryPathIds=$("#breadcrumbs-list").data("cat-path-ids"),categoryPathArray,category=0;if(localStorage){categoryPathArray=categoryPathIds?categoryPathIds.toString().split(","):[];if(categoryPathArray.length>0){category=categoryPathArray[categoryPathArray.length-1]}parameters.order=parameters.order?parameters.order:selectedOrder;stats=$.parseJSON(localStorage.getItem("bestMatchStats"));if(stats&&stats.phrase&&parameters.string){lengthDiff=Math.abs(stats.phrase.length-parameters.string.length);if(listing.bestmatchstats.levenshtein(stats.phrase,parameters.string)-lengthDiff>2&&parameters.mode!=="dym"){listing.bestmatchstats.initStats(parameters.string,category,parameters.mode,parameters.order,parameters.bmatch,resultsCount)}else{listing.bestmatchstats.setStats(stats,parameters.string,category,parameters.mode,parameters.order,parameters.bmatch,resultsCount)}}else{listing.bestmatchstats.initStats(parameters.string,category,parameters.mode,parameters.order,parameters.bmatch,resultsCount)}}},setStats:function(stats,phrase,category,mode,order,scenario,resultsCount){stats.phrase=phrase?decodeURI(phrase.replace(/\+/g," ")):"";stats.category=category;if(mode==="dym"){stats.isDidYouMean=true}if(mode==="desc"){stats.isDescription=true}if(order){stats.order=order}if(scenario){stats.scenario=scenario}stats.count++;stats.resultsCount=resultsCount;localStorage.setItem("bestMatchStats",JSON.stringify(stats))},increaseStatsCounter:function(){var stats,parameters=listing.urlParams(),resultsCount=parseInt($("#main-breadcrumb-search-hits").text().match(/\d+/),10);if(localStorage){stats=$.parseJSON(localStorage.getItem("bestMatchStats"));if(stats){if(parameters.order){if(!stats.order||stats.order!==parameters.order){stats.changedSort=true}stats.order=parameters.order}if(parameters.bmatch){stats.scenario=parameters.bmatch}stats.count++;stats.resultsCount=resultsCount;localStorage.setItem("bestMatchStats",JSON.stringify(stats))}}},clickItem:function(event){var stats,parameters=listing.urlParams(),limit=parameters.limit?parameters.limit:60,offset=parameters.page?(parameters.page-1)*limit:0,pagePos=0,pos=0,id=$(this).data("id"),worse=[],statsString="",attrValue="",classAttr=$(this).attr("class"),name,time=(new Date).getTime()/1e3;if(localStorage){stats=$.parseJSON(localStorage.getItem("bestMatchStats"));if(stats){$(".offer").each(function(pos){if(parseInt($(".offer:eq("+pos+")").data("id"),10)===parseInt(id,10)){pagePos=pos+1}});pos=offset+pagePos;$(".offer").each(function(pos){if(pos>=pagePos-4&&pos<pagePos-1){worse.push($(".offer:eq("+pos+")").data("id"))}});stats.pos=pos;stats.id=id;stats.worseItems=worse;stats.time=stats.startTime?time-stats.startTime:0;localStorage.setItem("bestMatchStats",JSON.stringify(stats));if(classAttr&&classAttr.match(/item\-cart/g)&&classAttr.match(/item\-cart/g).length){for(name in stats){statsString+="/bm_"+name+","+encodeURI(stats[name])}attrValue=$(this).attr("href");if(attrValue){$(this).attr("href",attrValue+statsString)}}}}},initStats:function(phrase,category,mode,order,scenario,resultsCount){var stats={phrase:phrase?decodeURI(phrase.replace(/\+/g," ")):"",count:1,isDidYouMean:mode==="dym",isDescription:mode==="desc",changedSort:false,worseItems:[],order:order,scenario:scenario,pos:0,id:0,startTime:(new Date).getTime()/1e3,resultsCount:resultsCount,category:category};localStorage.setItem("bestMatchStats",JSON.stringify(stats))},levenshtein:function(a,b){var matrix=[],i,j;if(parseInt(a.length,10)===0){return b.length}if(parseInt(b.length,10)===0){return a.length}for(i=0;i<=b.length;i++){matrix[i]=[i]}for(j=0;j<=a.length;j++){matrix[0][j]=j}for(i=1;i<=b.length;i++){for(j=1;j<=a.length;j++){if(b.charAt(i-1)===a.charAt(j-1)){matrix[i][j]=matrix[i-1][j-1]}else{matrix[i][j]=Math.min(matrix[i-1][j-1]+1,Math.min(matrix[i][j-1]+1,matrix[i-1][j]+1))}}}return matrix[b.length][a.length]}},brandzoneFeatures:{init:function(){if(this.isBrandzone){this.addBrandzoneClassToBody();this.showBackground();this.tabs.init()}},isBrandzone:$(".main-title h1").data("brandzone-enabled"),addBrandzoneClassToBody:function(){var brandzoneCSSClass="brandzone";$("body").addClass(brandzoneCSSClass)},showBackground:function(){var backgroundVisible=$(window).width()>1210,backgroundUrl;if(backgroundVisible){backgroundUrl=$("h1.brandzone").data("background-image-link");if(typeof backgroundUrl!=="undefined"){$("body").prepend('<div class="backgroundWrapper" style="background-image:url('+backgroundUrl+')"></div>');$(".backgroundWrapper").addClass("visible")}}},tabs:{init:function(){this.selectCorrectList();this.uiTabsInit();this.tabsService.urlsBack()},selectCorrectList:function(){var that=this;$.widget("ui.tabs",$.ui.tabs,{_getList:function(){var list=this.element.find(that.tabsService.tabsSelector);return list.length?list.eq(0):this._super()}})},uiTabsInit:function(){var that=this,tabIndexFromHash,brandTabIndex;$("#pagecontent1").tabs({select:function(event,ui){brandTabIndex=$(ui.tab).data("brand-tab-index");if(typeof brandTabIndex!=="undefined"&&brandTabIndex!==false){that.tabsService.getAndLoadTabContent(brandTabIndex,ui.tab)}that.tabsService.addRemoveActiveClass(ui.tab);if(event.currentTarget){that.urlsService.changeUrl(ui.index,ui.tab.hash)}},show:200,hide:200});tabIndexFromHash=this.tabsService.getTabIndexFromHash();this.tabsService.addRemoveActiveClass($(this.tabsService.tabsSelector+" li")[tabIndexFromHash]);$("#pagecontent1").tabs("option","active",tabIndexFromHash);if(tabIndexFromHash&&tabIndexFromHash!==1){that.tabsService.getAndLoadTabContent(tabIndexFromHash-2,$(this.tabsService.tabsSelector+" a")[tabIndexFromHash])}$("#sidebar, #listing").show();$(window).on("popstate",function(){if(that.tabsService.getTabIndexFromHash()){$("#pagecontent1").tabs("option","active",that.tabsService.getTabIndexFromHash())}})},tabsService:{uiTabs:null,tabsSelector:".brandzone-tabs",defaultTabIndex:1,urlsBack:function(){$(this.tabsSelector+" .non-tab-link").each(function(index,element){var elementTargetLink=$(element).data("target-url"),nonTabLink=$(element).clone().attr("href",elementTargetLink);$(element).replaceWith(nonTabLink[0].outerHTML)})},addRemoveActiveClass:function(tab){$(this.tabsSelector).find("li").removeClass("active");$(tab).closest("li").addClass("active")},getTabIndexFromHash:function(){if(window.location.hash){var tabIndex=this.defaultTabIndex;$(this.tabsSelector+" a").each(function(index,element){if(element.hash===window.location.hash){tabIndex=index}});return tabIndex}return this.defaultTabIndex},getAndLoadTabContent:function(tabIndex,tab){var tabContentContainer=$("#tab-"+tabIndex),us_id=$("input[name=us_id]").val();tabContentContainer.html('<div id="listing-loader" class="listing-loader">'+listing.labels.loading+"</div>");$.get("listing.php/getBrandZoneTabData?us_id="+us_id+"&tabIndex="+tabIndex,function(responseData){if(responseData.brandZoneTabData&&responseData.brandZoneTabData.content){tabContentContainer.html(responseData.brandZoneTabData.content);$(tab).data("brand-tab-index",false)}else{tabContentContainer.html('<div class="alert alert-danger">'+listing.labels.tabLoadingError+"</div>")}})}},urlsService:{urlHash:window.location.hash,locationPathAndSearch:function(){var locationPathUsId=window.location.search.match(/us_id=([^&]+)/);return window.location.pathname+"?"+(locationPathUsId?locationPathUsId[0]:"")},brandzoneItemsHref:null,changeUrl:function(tabIndex,tabHash){if(this.brandzoneItemsHref===null){this.brandzoneItemsHref=window.location.pathname+window.location.search}if(tabIndex!==1){history.pushState(null,"",this.locationPathAndSearch()+tabHash)}else{history.pushState(null,"",this.brandzoneItemsHref);this.brandzoneItemsHref=null}}}}},toggleDropdown:function(){$(this).parent().toggleClass("open")}};listing.init()});